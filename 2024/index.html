<!DOCTYPE html>
<html>
<head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Winter Windings</title>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN' crossorigin='anonymous'>

  <style>
    body {
      height: 100%;
      user-select: none;
      overflow: hidden;
    }

    #subheader {
      display: flex; 
      justify-content: space-between;
      align-items: center;
    }

    #current-word {
      min-height: 1.5em;
    }

    #word-svg .node {
      cursor: pointer;
      pointer-events: all;
    }

    #word-svg .link {
      fill: none;
    }

    #word-svg .node text {
      text-anchor: middle;
      dominant-baseline: middle;
      font-weight: bold;
      font-size: large;
    }

    .button-toolbar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .button {
      background-color: #fff;
      border: black solid 1px;
      border-radius: 1.5em;
      height: 3em;
      font-weight: 600;
      width: fit-content;
      display: flex;
      text-align: center;
      justify-content: center;
      align-items: center;
      padding: 15px;
      cursor: pointer;
    }

    .button.down {
      background-color: #e2e2e2;
    }

    .button.disabled {
      border: #666 solid 1px;
      color: #666;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0);
      visibility: hidden;
    }

    #overlay.show {
      background-color: rgba(0, 0, 0, 0.8);
      visibility: visible;
    }

    #overlay .container {
      height: 100%;
    }

    #picture {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      height: 100%;
    }

    #picture-word {
      border-radius: .5em;
      background-color: #fff;
    }

    #picture img {
      border-radius: 10px;  
      max-width: 100%; 
      max-height: calc(100% - 190px);
      object-fit: contain;
      display: none;
    }

    #picture video {
      display: none;
    }

    #picture img.show {
      display: block;
    }

    #picture video.show {
      display: block;
    }

    #card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0);  
      visibility: hidden;    
    }

    #card-overlay.show {
      background-color: rgba(0, 0, 0, 0.9);
      visibility: visible;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #card-overlay img {  
      max-width: 100%; 
      max-height: 100%;
      object-fit: contain;
    }

    #again-button {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translate(-50%, 0);
    }

  </style>
</head>

<body>

<div class='container p-2' style='position: relative;'>
  <h3 class='display-5'>Winter Windings 2024</h3>  
  <div id='subheader'>
    <small class='text-muted'>From the Peck-Borland family</small>
    <div class='btn-toolbar'>
      <button id='info-button' type='button' data-toggle='dropdown' style='background-color: rgba(0, 0, 0, 0); border: none;'>  
        <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='currentColor' class='bi bi-info-circle' viewBox='0 0 16 16'>
          <path d='M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16'/>
          <path d='m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0'/>
        </svg>
      </button>
      <div id='menu' class='dropdown'>
        <button type='button' data-toggle='dropdown' style='background-color: rgba(0, 0, 0, 0); border: none;'>  
          <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='currentColor' class='bi bi-list' viewBox='0 0 16 16'>
            <path fill-rule='evenodd' d='M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5'/>
          </svg>
        </button>
        <div class='dropdown-menu dropdown-menu-right'>
          <h6 class='dropdown-header'>Cards from previous years</h6>
          <a class='dropdown-item' href='https://davidborland.github.io/ChristmasCard/2020/'>2020</a>
          <a class='dropdown-item' href='https://davidborland.github.io/ChristmasCard/2021/'>2021</a>
          <a class='dropdown-item' href='https://davidborland.github.io/ChristmasCard/2022/'>2022</a>
          <a class='dropdown-item' href='https://davidborland.github.io/ChristmasCard/2023/'>2023</a>
        </div>
      </div>
    </div>
  </div>
  <hr />
  <div class='row'>
    <div class='col-md-6 align-self-center'>
      <div id='theme' class="card mx-auto text-center">
        <div class='card-header text-uppercase fw-bold'>
          Today's theme
        </div>
        <div class='card-body fw-bolder fs-4'>
          Family fun...
        </div>
      </div>
    </div>
    <div class='col-md-6 text-center'>
      <div id='current-word' class='text-center fw-bold fs-4 mt-2'></div>
      <svg id='word-svg'>
        <g class='links'></g>
        <g class='guess-links'>
          <path class='link'></path>
        </g>
        <g class='nodes'></g>
      </svg>  
    </div>
  </div>     
  <div id='toolbar' class='button-toolbar mt-4'>    
    <div id='hint-button' class='button'>Hint</div>
    <div class='fs-4'>
      <span id='num-found' class='fw-bold'></span> of <span id='num-total' class='fw-bold'></span> theme words found.
    </div>
  </div>
</div>

<div id='overlay'>
  <div class='container px-2'>
    <div id='picture' class='mt-4'>
      <div id='picture-word' class='text-center text-uppercase fw-bold fs-3'></div>
      <img />
      <video controls preload autoplay>
        <source type='video/mp4' />
      </video>
      <div id='image-buttons' class='button-toolbar'>
        <div id='next-button' class='button'>Next</div>
        <div id='close-button' class='button'>Close</div>
      </div>
    </div>
  </div>
</div>

<div id='card-overlay'>
  <img src='images/family_01.jpg' />
  <div id='again-button' class='button'>
    Congratulations!&nbsp;Try&nbsp;Again?</div>
</div>

<div id='instructions' class='modal' tabindex='-1'> 
  <div class='modal-dialog'> 
    <div class='modal-content'> 
      <div class='modal-header'> 
        <h5 class='modal-title'> 
          How to play Winter Windings
        </h5> 
      </div> 
      <div class='modal-body'> 
        <p> 
          <strong>Find theme words related to our past year.</strong>
          <ul>
            <li>Theme words stay <span class='strand-color'>highlighted</span> when found.</li>
            <li>Click or tap letters to create words. Select the last letter again to submit.</li>
            <li>Theme words fill the board entirely. No theme words overlap.</li>
            <li>Solving theme words will display a special suprise! Click on solved theme words to see it again.</li>
          </ul>          
        </p> 
        <p> 
          <strong>Find the "spangram."</strong>
          <ul>
            <li>The spangram describes the puzzle's theme and touches two opposite sides of the board. It may be two words.</li>
            <li>The spangram also <span class='spangram-color'>highlights</span> when found.</li>
            <li>
              An example spangram with corresponding theme words: 
              <span class='strand-color'>LIME</span>, 
              <span class='spangram-color'>FRUIT</span>, 
              <span class='strand-color'>BANANA</span>, 
              <span class='strand-color'>APPLE</span>, etc.
            </li>
          </ul>          
        </p> 
        <p> 
          <strong>Need a hint?</strong>
          <ul>
            <li>Find non-theme words to get hints.</li>
            <li>For every <span class='max-hint-guesses'></span> non-theme words you find, you earn a hint.</li>
            <li>Hints show the letters of a theme word, but not the order.</li>
          </ul>          
        </p> 
        <hr />
        <p>
          A shameless rip off of <a href='https://www.nytimes.com/games/strands'>Strands</a> from the New York Times.
        </p>
      </div> 
    </div> 
  </div>
</div>
  
<div id='hint-instructions' class='modal' tabindex='-1'>
  <div class='modal-dialog modal-dialog-centered'> 
    <div class='modal-content'> 
      <div class='modal-header'> 
        <h5 class='modal-title'> 
          Need a Hint?
        </h5> 
      </div> 
      <div class='modal-body'> 
        <p> 
          Finding non-theme words earns you hints that will help you find the theme words.
        </p>
      </div> 
    </div> 
  </div>
</div> 

<script src='https://code.jquery.com/jquery-3.3.1.slim.min.js' integrity='sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo' crossorigin='anonymous'></script>
<script src='https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js' integrity='sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49' crossorigin='anonymous'></script>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js' integrity='sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy' crossorigin='anonymous'></script>

<script type='module'>
  import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';

  let guess = [];
  let hintWord = null;
  let numHintGuesses = 0;
  let maxHintGuesses = 3;
  let alreadyGuessed = {};

  //const guessColor = '#bcc6cc';     // bluegrey
  const guessColor = '#e0be52';     // gold
  const strandColor = '#679576';    // green
  const spangramColor = '#d78685';  // red

  const wordColor = word => word.spangram ? spangramColor : strandColor;

  const setCurrentWord = s => d3.select("#current-word").text(s);
   const wordToString = word => word.map(d => d.value).join('');
  const setCurrentGuess = () => setCurrentWord(wordToString(guess).toUpperCase());

  const showImages = word => {
    let imageIndex = 0;

    const image = word.images[imageIndex];

    d3.select('#picture-word')
      .style('color', wordColor(word))
      .text(word.letters.map(letter => letter.value).join(''));

    if (image.includes('.mp4')) {
      d3.select('#picture img')
        .classed('show', false);

      d3.select('#picture video')
        .classed('show', true)
        .attr('src', `images/${ image }`)
        .on('oncanplay', function() {
          d3.select('#overlay')
            .classed('show', true);
        });
    }
    else {
      d3.select('#picture video')
        .classed('show', false);

      d3.select('#picture img')
        .classed('show', true)
        .attr('src', `images/${ image }`)
        .on('load', function() {
          d3.select('#overlay')
            .classed('show', true);
        });
    }

    d3.select('#next-button')
      .on('mousedown', function () {
        d3.select(this)
          .classed('down', true);

        const video = d3.select('#picture video').node();
        video.pause();
        video.currentTime = 0;

        imageIndex = (imageIndex + 1) % (word.images.length);

        const image = word.images[imageIndex];
        
        if (image.includes('.mp4')) {
          d3.select('#picture img')
            .classed('show', false);
        
          d3.select('#picture video')
            .classed('show', true)
            .attr('src', `images/${ image }`)
            .classed('show', true)
            .on('oncanplay', function() {
              d3.select('#overlay')
                .classed('show', true);
            });
        }
        else {
          d3.select('#picture video')
            .classed('show', false);
        
          d3.select('#picture img')
            .classed('show', true)
            .attr('src', `images/${ image }`)
            .on('load', function() {
              d3.select('#overlay')
                .classed('show', true);
            });
        }
      })
      .on('mouseup', function () {
        d3.select(this)
          .classed('down', false);
      });

    d3.select('#close-button')
      .on('mousedown', function () {
        d3.select(this)
          .classed('down', true);

        d3.select('#overlay')
          .classed('show', false);

        const video = d3.select('#picture video').node();
        video.pause();
        video.currentTime = 0;

        drawGrid();        

        // Check if found all
        const foundTotal = words.reduce((total, word) => total + (word.found ? 1 : 0), 0);

        if (foundTotal === words.length) {
          d3.select('#card-overlay')
            .classed('show', true);
        }
      })
      .on('mouseup', function () {
        d3.select(this)
          .classed('down', false);
      });        
    };

  
  const hintInstructions = new bootstrap.Modal(document.getElementById('hint-instructions'));
  d3.select('#hint-instructions')
    .on('mousedown', () => hintInstructions.hide());

  const updateHintButton = n => {
    const percent = (Math.min(n, maxHintGuesses) / maxHintGuesses * 100).toFixed(2) + '%';

    d3.select('#hint-button')
      .style('background-image', `linear-gradient(to right, ${ guessColor } ${ percent }, white ${ percent } 100%)`)
      .classed('disabled', n < maxHintGuesses);    
  };

  updateHintButton(numHintGuesses);

  const drawGrid = () => {
    // Get size
    const spacing = 60;
    const width = numColumns * spacing;
    const height = numRows * spacing;

    d3.select('#theme')
      .style('width', `${ width }px`);

    const radius = 20;

    // Draw using svg
    const xScale = d3.scalePoint()
      .domain(d3.range(numColumns))
      .range([0, width])
      .padding(0.5)

    const yScale = d3.scalePoint()
      .domain(d3.range(numRows))
      .range([0, height])
      .padding(0.5)

    // Nodes
    const nodes = d3.select('#word-svg')
      .attr('width', width)
      .attr('height', height)
      .select('.nodes').selectAll('.node')
      .data(letters)
      .join(
        enter => {
          const g = enter.append('g')
            .attr('class', 'node')              
            .on('click', (evt, d) => {
              // Check if already found 
              if (d.word.found && guess.length === 0) {
                showImages(d.word);
              }
              else {
                // Logic for guessing 
                if (guess.length === 0) {
                  // Empty guess, so add this letter
                  guess.push(d);
                  
                  setCurrentGuess();
                }
                else {
                  const i = guess.indexOf(d);

                  if (i === -1) {
                    // Check neighbor                  
                    const last = guess[guess.length - 1];

                    if (Math.abs(last.i - d.i) <= 1 && Math.abs(last.j - d.j) <= 1) {
                      // Add to guess
                      guess.push(d);
                    }
                    else {
                      // Reset guess
                      guess = [];
                    }
                    
                    setCurrentGuess();
                  }
                  else if (i === guess.length - 1) {
                    // Clicked the last letter, make guess
                    let found = null;

                    for (const word of words) {
                      if (word.letters.length !== guess.length) continue;

                      let correct = true;
                      for (let i = 0; i < guess.length; i++) {
                        if (guess[i] !== word.letters[i]) {
                          correct = false;
                          break;
                        }
                      }

                      if (correct) {
                        word.found = true;    
                        found = word;            
                        break;
                      }
                    }          

                    if (found) {
                      // Success
                      setCurrentGuess();
                      if (!found.spangram) showImages(found);
                      hintWord = null;
                      numHintGuesses = 0;
                    } 
                    else {
                      // Check length
                      if (guess.length <= 3) {
                        setCurrentWord('Too short');
                      }
                      else {
                        const guessString = wordToString(guess);

                        if (alreadyGuessed[guessString] === 1) {
                          setCurrentWord('Already found');
                        }
                        else if (dictionary[guessString] === 1) {
                          alreadyGuessed[guessString] = 1;
                          numHintGuesses++;
                          updateHintButton(numHintGuesses);
                        }
                        else {
                          setCurrentWord('Not in word list');
                        }
                      }
                    }                           
                    
                    guess = [];
                  }
                  else {
                    // Go back to this index in guess
                    guess.forEach((d, j) => {
                      if (j > i) d.state = null;
                    });
                    guess = guess.slice(0, i + 1);
                
                    setCurrentGuess();
                  }
                }
              }
              drawGrid();
          });

          g.append('circle')
            .style('stroke-dasharray', '6 3')
            .style('stroke-width', 3);

          g.append('text')            
            .attr('dy', '.1em');

          return g;
        }
      )
      .attr('transform', d => `translate(${ xScale(d.j) },${ yScale(d.i) })`);

    nodes.select('circle')
      .attr('r', radius)
      .style('fill', d => guess.includes(d) ? guessColor : d.word.found ? wordColor(d.word) : 'none')
      .style('stroke', d => !guess.includes(d) && d.word === hintWord ? strandColor : 'none');

    nodes.select('text')
      .text(d => d.value.toUpperCase());

    // Links
    const line = d3.line()
      .x(d => xScale(d.j))
      .y(d => yScale(d.i));

    const links = d3.select('#word-svg').select('.links').selectAll('.link')
      .data(words)
      .join(
        enter => {
          const g = enter.append('g')
            .attr('class', 'link')
            .on('click', (evt, d) => {
              console.log(d)
              if (d.found && guess.length === 0) {
                showImages(d);
              }
            });

          g.append('path');

          return g;
        }  
      )
      .style('stroke-width', radius / 2)
      .style('stroke', wordColor)
      .style('visibility', d => d.found ? null : 'hidden')
      .style('cursor', 'pointer');

    links.select('path')
      .attr('d', d => line(d.letters));

    // Guess links
    d3.select('#word-svg').select('.guess-links').select('.link')
      .style('stroke-width', radius / 2)
      .style('stroke', guessColor)
      .attr('d', line(guess));

    // Update found info
    d3.select('#num-found')
      .text(words.filter(word => word.found).length);

    d3.select('#num-total')
      .text(words.length);
  };

  d3.select('#theme').select('.card-header')
    .style('background-color', strandColor)

  const instructions = new bootstrap.Modal(document.getElementById('instructions'));
  d3.select('#instructions')
    .on('mousedown', () => instructions.hide());
  instructions.show();

  // Get data
  const [words, letters, numColumns, numRows] = await d3.json('grid.json').then(data => {
    const words = [];
    const letters = [];

    data.grid.forEach((row, i) => {
      row.split(' ').forEach((s, j) => {
        // Get character and word info from string
        const [char, info] = s.split('-');
        const [id, pos] = info.split('');

        // Get the word
        let word = words.find(word => word.id === id);
        if (!word) {
          word = { 
            id: id,
            letters: [],
            found: false,
            spangram: id === data.spangram,
            images: data.images[id]
          };

          words.push(word);
        }

        // Add the letter
        const letter = {
          value: char,
          word: word,
          pos: pos,
          i: i,
          j: j
        };

        letters.push(letter);        
        word.letters.push(letter);
      });
    });

    words.forEach(word => word.letters.sort((a, b) => d3.ascending(a.pos, b.pos)));

    const numColumns = d3.max(letters, letter => letter.j) + 1;
    const numRows = d3.max(letters, letter => letter.i) + 1;

    return [words, letters, numColumns, numRows];
  });

  console.log(letters, words);

  // Get dictionary words
  const dictionary = await d3.text('words_alpha.txt').then(data => {
    const words = data.split("\n").filter(word => word.length > 3);
    return words.reduce((words, word) => {
      words[word] = 1;
      return words;
    }, {});
  });

  // Grid
  d3.select('#word-grid')
    .style('grid-template-columns', `repeat(${ numColumns }, 1fr`);

  drawGrid();

  // Instructions
  d3.selectAll('.strand-color')
    .style('color', strandColor)
    .style('font-weight', 'bold');

  d3.selectAll('.spangram-color')
    .style('color', spangramColor)
    .style('font-weight', 'bold');

  d3.selectAll('.max-hint-guesses')
    .text(maxHintGuesses);

  // Buttons
  d3.select('#info-button')
    .on('mousedown', function () {
      instructions.show();
    });

  d3.select('#again-button')
    .on('mousedown', function () {
      d3.select(this)
        .classed('down', true);

      d3.select('#card-overlay')
        .classed('show', false);

      // Reset
      guess = [];
      hintWord = null;
      numHintGuesses = 0;
      maxHintGuesses = 3;
      alreadyGuessed = {};
      words.forEach(word => word.found = false);
      setCurrentWord();
      updateHintButton(numHintGuesses);

      drawGrid();
    })
    .on('mouseup', function () {
      d3.select(this)
        .classed('down', false);
    });

  d3.select('#hint-button')
    .on('mousedown', function () {
      d3.select(this)
        .classed('down', true);
       
        if (numHintGuesses >= maxHintGuesses) {
          const options = words.filter(word => !word.found && !word.spangram);
          hintWord = options[Math.floor(Math.random() * options.length)];
          numHintGuesses = 0;
          
          drawGrid();
          updateHintButton(numHintGuesses);
        }
        else {
          hintInstructions.show();
        }
    })
    .on('mouseup', function () {
      d3.select(this)
        .classed('down', false);
    });

  // Add an event listener that run the function when dimension change
  window.addEventListener('resize', drawGrid);

</script>

</body>
</html>